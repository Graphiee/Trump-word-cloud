let transcriptText = `
0.0 - 13.760000228881836: vice president vance speaker johnson senator thune chief justice roberts justices
13.760000228881836 - 24.68000030517578: united states supreme court president clinton president bush president obama
24.68000030517578 - 33.720001220703125: president biden vice president harris fellow citizens golden age america
33.720001220703125 - 44.47999954223633: begins right
44.47999954223633 - 51.119998931884766: day forward country flourish respected world
51.119998931884766 - 56.15999984741211: envy every nation allow taken advantage
56.15999984741211 - 59.31999969482422: longer
59.31999969482422 - 76.23999786376953: every single day trump administration simply put america first
76.23999786376953 - 79.5999984741211: sovereignty reclaimed
79.5999984741211 - 82.19999694824219: safety restored
82.19999694824219 - 86.4800033569336: scales justice rebalanced
86.4800033569336 - 92.30000305175781: vicious violent unfair weaponization justice department government
92.30000305175781 - 101.4000015258789: end
101.4000015258789 - 113.76000213623047: top priority create nation proud prosperous free
113.76000213623047 - 123.68000030517578: america soon greater stronger far exceptional ever
124.68000030517578 - 131.86000061035156: return presidency confident optimistic start thrilling
131.86000061035156 - 135.0399932861328: new era national success
135.0399932861328 - 141.0: tide change sweeping country sunlight pouring entire world
141.0 - 145.63999938964844: america chance seize opportunity like never
145.63999938964844 - 150.67999267578125: first must honest challenges face
150.67999267578125 - 155.9199981689453: plentiful annihilated great momentum world
155.9199981689453 - 160.1199951171875: witnessing united states america
160.1199951171875 - 164.55999755859375: gather today government confronts crisis trust
164.55999755859375 - 170.6999969482422: many years radical corrupt establishment extracted power wealth citizens
170.6999969482422 - 177.72000122070312: pillars society lay broken seemingly complete disrepair
177.75999450683594 - 182.5399932861328: government manage even simple crisis home
182.5399932861328 - 188.9199981689453: time stumbling continuing catalogue catastrophic events abroad
188.9199981689453 - 195.1199951171875: fails protect magnificent lawabiding american citizens provides sanctuary
195.1199951171875 - 201.22000122070312: protection dangerous criminals many prisons mental institutions
201.22000122070312 - 205.32000732421875: illegally entered country world
205.32000732421875 - 210.75999450683594: government given unlimited funding defense foreign borders
210.75999450683594 - 217.63999938964844: refuses defend american borders importantly people
217.63999938964844 - 224.0: country longer deliver basic services times emergency recently shown
224.0 - 235.0: wonderful people north carolina treated badly states
235.0 - 239.86000061035156: still suffering hurricane took place many months ago
239.86000061035156 - 245.83999633789062: recently los angeles watching fires still tragically burn
245.83999633789062 - 253.1999969482422: weeks ago without even token defense theyre raging houses communities
253.1999969482422 - 257.739990234375: even affecting wealthiest powerful individuals country
257.739990234375 - 260.9599914550781: sitting right
260.9599914550781 - 263.4800109863281: dont home longer
263.4800109863281 - 265.6000061035156: thats interesting
265.6000061035156 - 268.0400085449219: cant let happen
268.0400085449219 - 271.8800048828125: everyone unable anything
271.8800048828125 - 273.6400146484375: thats going change
273.6400146484375 - 278.0: public health system deliver times disaster yet money
278.0 - 282.44000244140625: spent country anywhere world
282.44000244140625 - 287.1000061035156: education system teaches children ashamed
287.1000061035156 - 294.760009765625: many cases hate country despite love try desperately provide
294.760009765625 - 300.2799987792969: change starting today change quickly
300.2799987792969 - 318.3599853515625: recent election mandate completely totally reverse horrible betrayal
318.3599853515625 - 325.9599914550781: many betrayals taken place give people back faith
325.9599914550781 - 331.4800109863281: wealth democracy indeed freedom
331.4800109863281 - 346.79998779296875: moment americas decline
346.79998779296875 - 353.79998779296875: liberties nations glorious destiny longer denied immediately
353.8399963378906 - 359.9200134277344: restore integrity competency loyalty americas government
359.9200134277344 - 364.1600036621094: past eight years tested challenged president
364.1600036621094 - 370.1199951171875: 250year history ive learned lot along way
370.1199951171875 - 377.4200134277344: journey reclaim republic easy one tell
377.4200134277344 - 386.4599914550781: wish stop cause tried take freedom indeed take life
386.4599914550781 - 391.4200134277344: months ago beautiful pennsylvania field assassins bullet ripped
391.4200134277344 - 394.29998779296875: ear
394.29998779296875 - 400.6199951171875: felt believe even life saved reason
400.6199951171875 - 405.739990234375: saved god make america great
405.739990234375 - 408.7799987792969: thank
408.7799987792969 - 411.7799987792969: thank
411.7799987792969 - 415.7799987792969: thank much
415.7799987792969 - 418.7799987792969: thank
418.7799987792969 - 421.7799987792969: thank
421.7799987792969 - 424.7799987792969: thank
424.7799987792969 - 427.7799987792969: thank
427.94000244140625 - 430.94000244140625: thank
435.94000244140625 - 443.0400085449219: day administration american patriots working
443.0400085449219 - 447.70001220703125: meet every crisis dignity power strength
447.70001220703125 - 453.8599853515625: move purpose speed bring back hope prosperity safety peace
453.8599853515625 - 459.7799987792969: citizens every race religion color creed
459.7799987792969 - 476.2200012207031: american citizens january 20th 2025 liberation day
476.2200012207031 - 481.1000061035156: hope recent presidential election remembered greatest
481.1000061035156 - 486.1000061035156: consequential election history country
486.1000061035156 - 492.1400146484375: victory showed entire nation rapidly unifying behind agenda dramatic
492.1400146484375 - 497.6600036621094: increases support virtually every element society young old men
497.6600036621094 - 505.17999267578125: women african americans hispanic americans asian americans urban suburban rural
505.17999267578125 - 511.6199951171875: importantly powerful win seven swing states popular
511.6199951171875 - 519.780029296875: vote millions people
519.780029296875 - 525.260009765625: black hispanic communities want thank tremendous outpouring
525.260009765625 - 530.4199829101562: love trust shown vote
530.4199829101562 - 534.7000122070312: set records forget
534.7000122070312 - 539.3400268554688: ive heard voices campaign look forward working
539.3400268554688 - 541.02001953125: years come
541.02001953125 - 547.219970703125: today martin luther king day honor great honor honor
547.219970703125 - 552.4199829101562: strive together make dream reality
552.4199829101562 - 574.780029296875: make dream come true
574.780029296875 - 583.4199829101562: national unity returning america confidence pride soaring like never
583.4199829101562 - 584.8200073242188: 
584.8200073242188 - 589.6799926757812: everything administration inspired strong pursuit excellence
589.6799926757812 - 592.4400024414062: unrelenting success
592.4400024414062 - 599.8200073242188: forget country forget constitution forget
599.8200073242188 - 600.8200073242188: god
600.8200073242188 - 614.02001953125: cant
614.02001953125 - 618.6599731445312: today sign series historic executive orders
618.6599731445312 - 624.5: actions begin complete restoration america revolution
624.5 - 626.219970703125: common sense
626.219970703125 - 629.5: common sense
629.5 - 636.5: first declare national emergency southern border
659.5 - 668.97998046875: illegal entry immediately halted begin process returning
668.97998046875 - 675.9400024414062: millions millions criminal aliens back places came
675.9400024414062 - 686.5800170898438: reinstate remain mexico policy
686.5800170898438 - 696.780029296875: end practice catch release send troops southern border
696.780029296875 - 705.739990234375: repel disastrous invasion country
705.739990234375 - 713.1400146484375: orders signed today also designating cartels foreign terrorist
713.2999877929688 - 731.3400268554688: organizations
731.3400268554688 - 740.3400268554688: invoking alien enemies act 1798 direct government use full
740.3400268554688 - 745.1400146484375: immense power federal state law enforcement eliminate presence
745.1400146484375 - 753.4600219726562: foreign gangs criminal networks bringing devastating crime soil including
753.4600219726562 - 762.8599853515625: cities inner cities
762.8599853515625 - 768.3800048828125: commanderinchief higher responsibility defend country threats
768.3800048828125 - 773.260009765625: invasions exactly going
773.260009765625 - 776.6599731445312: level nobody ever seen
776.6599731445312 - 782.760009765625: next direct members cabinet marshal vast powers disposal
782.760009765625 - 795.9400024414062: defeat record inflation rapidly bring costs prices
795.9400024414062 - 801.7000122070312: inflation crisis caused massive overspending escalating energy prices
801.7000122070312 - 807.9400024414062: today also declare national energy emergency
807.9400024414062 - 830.9000244140625: drill baby drill
830.9000244140625 - 835.8200073242188: america manufacturing nation something
835.8200073242188 - 841.1400146484375: manufacturing nation ever largest amount oil gas country
841.1400146484375 - 849.3400268554688: earth going use
849.3400268554688 - 857.0999755859375: bring prices fill strategic reserves right top export
857.0999755859375 - 865.1400146484375: american energy world
865.1400146484375 - 871.4199829101562: rich nation liquid gold feet
871.4199829101562 - 873.5999755859375: help
873.5999755859375 - 878.5800170898438: actions today end green new deal revoke electric
878.5800170898438 - 885.0599975585938: vehicle mandate saving auto industry keeping sacred pledge great
885.0599975585938 - 886.739990234375: american autoworkers
886.739990234375 - 901.1399898529053: words youll able buy car choice
901.1399898529053 - 906.0399894714355: build automobiles america rate nobody could dreamt possible
906.0399894714355 - 908.5999908447266: years ago
908.5999908447266 - 913.9599895477295: thank autoworkers nation inspiring vote confidence
913.9599895477295 - 918.9399909973145: tremendously vote
918.9399909973145 - 926.1999893188477: immediately begin overhaul trade system protect american workers
926.1999893188477 - 927.679988861084: families
927.679988861084 - 934.4399909973145: instead taxing citizens enrich countries tariff tax foreign
934.4399909973145 - 942.8399887084961: countries enrich citizens
942.8399887084961 - 952.5599899291992: purpose establishing external revenue service collect tariffs
952.5599899291992 - 955.119987487793: duties revenues
955.119987487793 - 962.3999938964844: massive amounts money pouring treasury coming foreign sources
962.3999938964844 - 968.4799880981445: american dream soon back thriving like never restore competence
968.4799880981445 - 971.239990234375: effectiveness federal government
971.239990234375 - 990.239990234375: administration establish brand new department government efficiency
990.239990234375 - 996.7199935913086: years years illegal unconstitutional federal efforts restrict free expression
996.7199935913086 - 1003.6399917602539: also sign executive order immediately stop government censorship bring back
1003.6399917602539 - 1022.7599945068359: free speech america
1022.7599945068359 - 1028.3199920654297: never immense power state weaponized persecute political
1028.3199920654297 - 1032.999984741211: opponents something know something
1032.999984741211 - 1034.9599914550781: allow happen
1034.9599914550781 - 1036.8199920654297: happen
1036.8199920654297 - 1043.239990234375: leadership restore fair equal impartial justice constitutional
1043.239990234375 - 1049.5999908447266: rule law
1049.5999908447266 - 1058.8799896240234: going bring law order back cities
1058.8799896240234 - 1065.5399932861328: week also end government policy trying socially engineer race
1065.5399932861328 - 1077.2799835205078: gender every aspect public private life
1077.2799835205078 - 1088.6399841308594: forge society colorblind meritbased
1088.6399841308594 - 1094.9199829101562: today henceforth official policy united states government
1094.9199829101562 - 1116.7999877929688: two genders male female
1116.7999877929688 - 1122.3599853515625: week reinstate servicemembers unjustly expelled military
1122.3599853515625 - 1139.3599853515625: objecting covid vaccine mandate full back pain
1139.3599853515625 - 1144.8199768066406: sign order stop warriors subjected radical political
1144.8199768066406 - 1148.1600036621094: theories social experiments duty
1148.1600036621094 - 1154.0799865722656: going end immediately
1154.0799865722656 - 1174.3999938964844: armed forces freed focus sole mission defeating americas enemies
1174.3999938964844 - 1194.3999938964844: like 2017 build strongest military world ever seen
1194.3999938964844 - 1200.239990234375: measure success battles win also wars
1200.239990234375 - 1224.8399963378906: end perhaps importantly wars never get
1224.8399963378906 - 1230.1199951171875: proudest legacy peacemaker unifier
1230.1199951171875 - 1233.6799926757812: thats want peacemaker unifier
1233.6799926757812 - 1240.6399841308594: pleased say yesterday one day assumed office hostages
1240.6399841308594 - 1266.6399841308594: middle east coming back home families
1266.6399841308594 - 1271.239990234375: america reclaim rightful place greatest powerful respected
1271.239990234375 - 1277.5999755859375: nation earth inspiring awe admiration entire world
1277.5999755859375 - 1283.7200012207031: short time going changing name gulf mexico
1283.7200012207031 - 1293.239990234375: gulf america restore name great president william mckinley
1293.239990234375 - 1306.1199951171875: mount mckinley belongs
1306.1199951171875 - 1312.4400024414062: president mckinley made country rich tariffs talent
1312.4400024414062 - 1317.5399780273438: natural businessman gave teddy roosevelt money many great
1317.5399780273438 - 1324.0999755859375: things including panama canal foolishly given country
1324.0999755859375 - 1329.4199829101562: panama united states united states mean think spent
1329.4199829101562 - 1337.8599853515625: money ever spent project lost 38000 lives building
1337.8599853515625 - 1340.0199890136719: panama canal
1340.0199890136719 - 1345.3399963378906: treated badly foolish gift never made
1345.3399963378906 - 1349.2599792480469: panamas promise broken
1349.2599792480469 - 1354.739990234375: purpose deal spirit treaty totally violated
1354.739990234375 - 1363.2999877929688: american ships severely overcharged treated fairly way shape
1363.2999877929688 - 1364.2999877929688: form
1364.2999877929688 - 1367.4199829101562: includes united states navy
1367.4199829101562 - 1371.1399841308594: china operating panama canal
1371.1399841308594 - 1372.8199768066406: didnt give china
1372.8199768066406 - 1374.5399780273438: gave panama
1374.5399780273438 - 1376.3399963378906: taking back
1376.3399963378906 - 1399.239990234375: message americans today time act
1399.239990234375 - 1405.3200073242188: courage vigor vitality historys greatest civilization
1405.3200073242188 - 1412.5599975585938: liberate nation lead new heights victory success
1412.5599975585938 - 1413.9599609375: deterred
1413.9599609375 - 1419.5999755859375: together end chronic disease epidemic keep children safe healthy
1419.5999755859375 - 1420.5999755859375: diseasefree
1420.5999755859375 - 1427.52001953125: united states consider growing nation one increases
1427.52001953125 - 1433.6599731445312: wealth expands territory builds cities raises expectations carries
1433.6599731445312 - 1437.8800048828125: flag new beautiful horizons
1437.8800048828125 - 1443.760009765625: pursue manifest destiny stars launching american astronauts
1443.760009765625 - 1452.719970703125: plant stars stripes planet mars
1452.719970703125 - 1472.0399780273438: ambition lifeblood great nation
1472.0399780273438 - 1477.0399780273438: right nation ambitious
1477.0399780273438 - 1481.0800170898438: theres nation like nation
1481.0800170898438 - 1486.5599975585938: americans explorers builders innovators entrepreneurs pioneers
1486.5599975585938 - 1490.0399780273438: spirit frontier written hearts
1490.0399780273438 - 1497.6799926757812: call next great adventure resounds within souls
1497.6799926757812 - 1504.1199951171875: american ancestors turned small group colonies edge vast continent
1504.1199951171875 - 1509.0399780273438: mighty republic extraordinary citizens earth
1509.0399780273438 - 1511.7999877929688: one comes close
1511.7999877929688 - 1518.1199951171875: americans pushed thousands miles rugged land untamed wilderness
1518.1199951171875 - 1525.3200073242188: crossed deserts scaled mountains braved untold dangers wild west ended slavery
1525.3200073242188 - 1531.4599609375: rescued millions tyranny lifted billions poverty harnessed electricity split
1531.4599609375 - 1538.5599975585938: atom launched mankind heavens put universe human knowledge
1538.5599975585938 - 1542.0800170898438: palm human hand
1542.0800170898438 - 1548.2000122070312: work together nothing dream achieve
1548.2000122070312 - 1555.5999755859375: many people thought impossible stage historic political comeback
1555.5999755859375 - 1557.3999633789062: see today
1557.3999633789062 - 1579.3599853515625: american people spoken
1579.3599853515625 - 1584.3999633789062: stand proof never believe something impossible
1584.3999633789062 - 1586.0: 
1586.0 - 1596.6799926757812: america impossible best
1596.6799926757812 - 1603.6799926757812: new york los angeles philadelphia phoenix chicago miami houston
1603.6799926757812 - 1610.8800048828125: right washington country forged built generations
1610.8800048828125 - 1617.47998046875: patriots gave everything rights freedom
1617.47998046875 - 1623.6799926757812: farmers soldiers cowboys factory workers steelworkers coal miners
1623.6799926757812 - 1629.8999633789062: police officers pioneers pushed onward marched forward let obstacle defeat
1629.8999633789062 - 1633.3200073242188: spirit pride
1633.3200073242188 - 1640.52001953125: together laid railroads raised skyscrapers built great highways
1640.52001953125 - 1647.3200073242188: two world wars defeated fascism communism triumphed every single
1647.3200073242188 - 1650.8200073242188: challenge faced
1650.8200073242188 - 1655.52001953125: together stand verge four greatest years
1655.52001953125 - 1657.7999877929688: american history
1657.7999877929688 - 1663.3200073242188: help restore americas promise rebuild nation
1663.3200073242188 - 1666.3999633789062: love love much
1666.3999633789062 - 1673.0399780273438: one people one family one glorious nation god every parent dreams
1673.0399780273438 - 1679.3999633789062: child every child dreams future fight
1679.3999633789062 - 1682.3999633789062: win
1682.3999633789062 - 1685.3999633789062: going win like never
1685.3999633789062 - 1687.3999633789062: thank
1687.3999633789062 - 1689.3999633789062: thank
1689.3999633789062 - 1691.3999633789062: thank
1691.3999633789062 - 1693.3999633789062: thank
1693.3999633789062 - 1695.3999633789062: thank
1695.3999633789062 - 1697.3999633789062: thank
1697.3999633789062 - 1699.3999633789062: thank
1699.3999633789062 - 1701.3999633789062: thank
1701.3999633789062 - 1703.3999633789062: thank
1703.3999633789062 - 1705.3999633789062: thank
1705.3999633789062 - 1710.5999755859375: recent years nation suffered greatly going bring back make
1710.5999755859375 - 1715.0399780273438: great greater ever
1715.0399780273438 - 1720.760009765625: nation like full compassion courage exceptionalism
1720.760009765625 - 1726.8800048828125: power stop wars bring new spirit unity world angry
1726.8800048828125 - 1730.52001953125: violent totally unpredictable
1730.52001953125 - 1737.2000122070312: america respected admired including people religion faith
1737.2000122070312 - 1738.5999755859375: goodwill
1738.5999755859375 - 1740.3200073242188: prosperous
1740.3200073242188 - 1742.1199951171875: proud
1742.1199951171875 - 1746.239990234375: strong win like never
1746.239990234375 - 1748.0800170898438: conquered
1748.0800170898438 - 1750.760009765625: intimidated
1750.760009765625 - 1754.5999755859375: broken fail
1754.5999755859375 - 1760.0800170898438: day united states america free sovereign independent
1760.0800170898438 - 1761.0800170898438: nation
1761.0800170898438 - 1762.719970703125: stand bravely
1762.719970703125 - 1764.9599609375: live proudly
1764.9599609375 - 1770.8399658203125: dream boldly nothing stand way americans
1770.8399658203125 - 1776.3800048828125: future golden age begun
1776.3800048828125 - 1777.3800048828125: thank
1777.3800048828125 - 1778.6400146484375: god bless america
`;

let topicsText = `
Introduction and Opening Remarks: 00:00 - 00:32
Vision for America's Future: 00:32 - 02:26
Challenges Facing the Nation: 02:26 - 05:10
Restoring Trust and Competence: 05:10 - 10:30
National Security and Immigration: 10:30 - 12:57
Economic Reforms and Energy Policy: 12:57 - 15:22
Trade and Manufacturing Revival: 15:22 - 16:10
Government Efficiency and Free Speech: 16:10 - 18:39
Military Strength and National Unity: 18:39 - 23:37
Historical Achievements and Future Ambitions: 23:37 - 27:35
Conclusion and Call to Action: 27:35 - 30:00
`;

// Get dimensions for word cloud
const width = document.getElementById("word-cloud").offsetWidth;
const height = document.getElementById("word-cloud").offsetHeight;

// Convert MM:SS to seconds
function parseTime(timeStr) {
	if (!timeStr) return 0;
	const [mins, secs] = timeStr.split(":").map(Number);
	return mins * 60 + secs;
}

// Parse topics
const topics = topicsText
	.trim()
	.split("\n")
	.map((line) => {
		try {
			const [topic, rest] = line.split(": ");
			if (!rest) return null;

			const parts = rest.split(" ");
			const timeRange = parts[0] + " " + parts[1] + " " + parts[2];
			const [startTime, endTime] = timeRange.split(" - ");
			const description = parts.slice(3).join(" ");
			return {
				topic,
				start: parseTime(startTime),
				end: parseTime(endTime),
				description,
			};
		} catch (e) {
			console.error("Error parsing topic:", line, e);
			return null;
		}
	})
	.filter(Boolean);

// Create topic buttons
const topicsList = document.getElementById("topics-list");
topics.forEach((topic, index) => {
	const button = document.createElement("button");
	button.className = "topic-button";
	button.textContent = `${topic.topic}`;
	button.title = topic.description;
	button.addEventListener("click", () => {
		document
			.querySelectorAll(".topic-button")
			.forEach((btn) => btn.classList.remove("active"));
		button.classList.add("active");
		rangeSlider.noUiSlider.set([topic.start, topic.end]);
	});
	topicsList.appendChild(button);
});

// Parse transcript into segments with timestamps
const segments = transcriptText
	.trim()
	.split("\n")
	.map((line) => {
		const match = line.match(/(\d+\.?\d*)\s*-\s*(\d+\.?\d*):\s*(.*)/);
		if (match) {
			return {
				startTime: parseFloat(match[1]),
				endTime: parseFloat(match[2]),
				text: match[3].trim(),
			};
		}
		return null;
	})
	.filter(Boolean);

// Get the total duration
const maxDuration = Math.max(...segments.map((seg) => seg.endTime));

// Create range slider container
const sliderContainer = document.createElement("div");
sliderContainer.style.margin = "20px";
document
	.getElementById("word-cloud")
	.parentNode.insertBefore(
		sliderContainer,
		document.getElementById("word-cloud")
	);

// Time formatting helper
function formatTime(seconds) {
	const mins = Math.floor(seconds / 60);
	const secs = Math.floor(seconds % 60);
	return `${mins}:${secs.toString().padStart(2, "0")}`;
}

function draw(words) {
	d3.select("#word-cloud").selectAll("*").remove();
	// Find the bounds of the word cloud
	let minX = Infinity,
		maxX = -Infinity;
	let minY = Infinity,
		maxY = -Infinity;
	words.forEach((d) => {
		const w = d.text.length * (d.size / 2); // Increased width multiplier
		const h = d.size * 1.2; // Added height multiplier
		minX = Math.min(minX, d.x - w / 2);
		maxX = Math.max(maxX, d.x + w / 2);
		minY = Math.min(minY, d.y - h / 2);
		maxY = Math.max(maxY, d.y + h / 2);
	});

	const cloudWidth = maxX - minX;
	const cloudHeight = maxY - minY;
	const padding = 30; // Increased padding

	const svg = d3
		.select("#word-cloud")
		.append("svg")
		.attr("width", "100%")
		.attr("height", "100%")
		.attr(
			"viewBox",
			`${minX - padding} ${minY - padding} ${cloudWidth + padding * 2} ${
				cloudHeight + padding * 2
			}`
		);

	const container = svg.append("g");

	container
		.selectAll("text")
		.data(words)
		.enter()
		.append("text")
		.style("font-size", (d) => `${d.size}px`)
		.style("font-family", "Arial")
		.style("fill", () => d3.schemeCategory10[Math.floor(Math.random() * 10)])
		.attr("text-anchor", "middle")
		.attr("transform", (d) => `translate(${d.x},${d.y})rotate(${d.rotate})`)
		.text((d) => d.text);
}

// Add bars
function updateWordCloud(startTime, endTime) {
	const filteredText = segments
		.filter((seg) => seg.startTime >= startTime && seg.endTime <= endTime)
		.map((seg) => seg.text)
		.join(" ");

	const words = filteredText
		.toLowerCase()
		.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, "")
		.split(/\s+/)
		.filter((word) => word.length > 2)
		.reduce((acc, word) => {
			acc[word] = (acc[word] || 0) + 1;
			return acc;
		}, {});

	// Get top 10 words by frequency
	const topWords = Object.entries(words)
		.sort((a, b) => b[1] - a[1])
		.slice(0, 10);

	// Update frequency table
	const tableBody = document.querySelector("#frequency-table tbody");
	tableBody.innerHTML = topWords
		.map(
			([word, count]) => `
			<tr>
				<td>${word}</td>
				<td>${count}</td>
			</tr>
		`
		)
		.join("");

	const wordData = Object.entries(words)
		.map(([text, size]) => ({ text, size: size * 10 }))
		.sort((a, b) => b.size - a.size)
		.slice(0, 100);

	const layout = d3.layout
		.cloud()
		.size([width * 1.2, height * 1.2])
		.words(wordData)
		.padding(10)
		.rotate(() => ~~(Math.random() * 2) * 90)
		.fontSize((d) => d.size)
		.on("end", draw);

	layout.start();
}

// Initialize noUiSlider
const rangeSlider = document.getElementById("range-slider");
noUiSlider.create(rangeSlider, {
	start: [0, maxDuration],
	connect: true,
	step: 0.1,
	range: {
		min: 0,
		max: maxDuration,
	},
});

// Add event listener for the range slider
rangeSlider.noUiSlider.on("update", function (values) {
	const [start, end] = values.map(parseFloat);
	document.getElementById("timeRange").textContent = `${formatTime(
		start
	)} - ${formatTime(end)}`;
	updateWordCloud(start, end);

	// Update active topic button based on time range
	const activeTopicIndex = topics.findIndex(
		(topic) =>
			Math.abs(topic.start - start) < 0.1 && Math.abs(topic.end - end) < 0.1
	);

	document.querySelectorAll(".topic-button").forEach((btn, index) => {
		btn.classList.toggle("active", index === activeTopicIndex);
	});
});

// Initial word cloud
updateWordCloud(0, maxDuration);
